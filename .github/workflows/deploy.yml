name: BamVoo CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Allow manual triggers

env:
  NODE_VERSION: '18'
  AWS_REGION: 'us-east-1'

jobs:
  test:
    name: ğŸ§ª Test
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¥ Install dependencies
      run: npm ci
      
    - name: ğŸ§ª Run local tests
      run: npm run test:local
      
    - name: ğŸ§ª Run unit tests
      run: npm test
      
    - name: ğŸ“Š Upload test coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: codecov-umbrella

  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¥ Install dependencies
      run: npm ci
      
    - name: ğŸ”’ Run security audit
      run: npm audit --audit-level=high
      
    - name: ğŸ”’ Run Snyk security scan
      uses: snyk/actions/node@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high

  build:
    name: ğŸ—ï¸ Build
    runs-on: ubuntu-latest
    needs: [test, security]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¥ Install dependencies
      run: npm ci
      
    - name: ğŸ—ï¸ Build package
      run: |
        npm run build
        zip -r bamvoo.zip . -x "node_modules/*" ".git/*" "test/*" "*.md" ".github/*"
        
    - name: ğŸ“¦ Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: bamvoo-build
        path: bamvoo.zip

  deploy-staging:
    name: ğŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop'
    environment: staging
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¥ Install dependencies
      run: npm ci
      
    - name: ğŸ“¥ Install Serverless Framework
      run: npm install -g serverless
      
    - name: ğŸ” Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: ğŸš€ Deploy to staging
      env:
        OCTO_APP_TOKEN: ${{ secrets.OCTO_APP_TOKEN }}
        ALEXA_SKILL_ID: ${{ secrets.ALEXA_SKILL_ID_STAGING }}
        ALEXA_ACCESS_TOKEN: ${{ secrets.ALEXA_ACCESS_TOKEN_STAGING }}
      run: |
        serverless deploy --stage staging --verbose
        
    - name: ğŸ“Š Deploy status
      run: |
        echo "âœ… Staging deployment completed"
        echo "ğŸ”— Lambda ARN: $(aws lambda get-function --function-name bamvoo-staging-alexaSkill --query 'Configuration.FunctionArn' --output text)"
        echo "ğŸ”— API Gateway: https://$(aws apigateway get-rest-apis --query 'items[?name==`bamvoo-staging`].id' --output text).execute-api.us-east-1.amazonaws.com/staging"

  deploy-production:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¥ Install dependencies
      run: npm ci
      
    - name: ğŸ“¥ Install Serverless Framework
      run: npm install -g serverless
      
    - name: ğŸ” Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: ğŸš€ Deploy to production
      env:
        OCTO_APP_TOKEN: ${{ secrets.OCTO_APP_TOKEN }}
        ALEXA_SKILL_ID: ${{ secrets.ALEXA_SKILL_ID_PROD }}
        ALEXA_ACCESS_TOKEN: ${{ secrets.ALEXA_ACCESS_TOKEN_PROD }}
      run: |
        serverless deploy --stage prod --verbose
        
    - name: ğŸ“Š Deploy status
      run: |
        echo "âœ… Production deployment completed"
        echo "ğŸ”— Lambda ARN: $(aws lambda get-function --function-name bamvoo-prod-alexaSkill --query 'Configuration.FunctionArn' --output text)"
        echo "ğŸ”— API Gateway: https://$(aws apigateway get-rest-apis --query 'items[?name==`bamvoo-prod`].id' --output text).execute-api.us-east-1.amazonaws.com/prod"

  notify:
    name: ğŸ“¢ Notify
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always()
    
    steps:
    - name: ğŸ“¢ Deployment notification
      run: |
        echo "ğŸš€ BamVoo deployment completed!"
        echo "Repository: ${{ github.repository }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "Status: ${{ job.status }}"
      if: always() 